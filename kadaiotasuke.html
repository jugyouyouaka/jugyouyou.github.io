<!DOCTYPE html>
<html lang="ja">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Content-Style-Type" content="text/css">
    <meta http-equiv="Content-Script-Type" content="text/javascript">
    <title>Spoken Dialog by Javascript</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }
        button {
            font-size: 16px;
            padding: 10px;
            cursor: pointer;
        }
        #startButton::before {
            content: 'ğŸ¤ '; /* Microphone icon */
        }
        #stopButton::before {
            content: 'ğŸ›‘ '; /* Stop icon */
        }
    </style>
</head>
<body>
<h1>èª²é¡Œã‚„ã‚‹ã¨ãã«ä½¿ã†ã‚ˆã†ãªã‚„ã¤</h1>

<p>
    <button id="startButton">start</button>
    <button id="stopButton">stop</button>
</p>

<p>
    <div id="resultOutput"></div>
</p>

<script>
var response = {
    "ã‚ãªãŸ,èª°": ["ç§ã¯ã‚ãªãŸã®ãŠå‹é”ã§ã™ã€‚ãŸã¶ã‚“"],
    "åå‰ã¯": ["ç§ã¯åã‚‚ãªãæ–°ç±³ãƒœã‚¤ã‚¹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚åå‰ã¯ã¾ã ãªã„"],
    "ä½•æ­³": ["ç§ã¯ã‚ãªãŸã«å‘¼ã°ã‚ŒãŸåº¦ã«ç”Ÿã¾ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šç”Ÿã¾ã‚ŒãŸã¦"],
    "å…ƒæ°—": ["ãŠãã‚‰ãå…ƒæ°—"],
    "å¥½ããª,é£Ÿã¹ç‰©": ["æ–°é®®ãªæƒ…å ±ä½“ã¯ç¾å‘³ã§ã™ã€‚äººé–“ãŒé£Ÿã¹ã‚‹ã‚ªã‚µã‚·ãƒŸâ€¦ï¼Ÿã¯ã“ã®ã‚ˆã†ãªå‘³ãŒã™ã‚‹ã®ã§ã—ã‚‡ã†ã‹"],
    "èª²é¡Œ,ã‚„ã‚‹": ["é ‘å¼µã£ã¦ãã ã•ã„ã­", "https://moodle2024.wakayama-u.ac.jp/2024/my/", "https://www.notion.so/"],
    "æ•™ãˆã¦,å…ˆç”Ÿ": ["ç§ã¯ã¾ã æ–°ç±³ãªã®ã§æ•™ãˆã‚‰ã‚Œã¾ã›ã‚“ãŒã€ä»£ã‚ã‚Šã«çŸ¥ã‚Šåˆã„ã‚’æ•°äººç´¹ä»‹ã—ã¾ã—ã‚‡ã†", "https://chatgpt.com/", "https://www.deepl.com/ja/translator", "https://gemini.google.com/app?hl=ja"],
    "æ•™è‚²ã‚µãƒãƒ¼ãƒˆ": ["ã“ã‚Œã®ã“ã¨ã§ã™ã‹ï¼Ÿ", "https://kmags.wakayama-u.ac.jp/campusweb/campusportal.do?page=main"],
    "ä»Š,ä½•æ™‚": [""] // æ™‚é–“ã‚’å‹•çš„ã«ã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ã®ç©ºã®é…åˆ—
    "ä»Šæ—¥,æ™‚é–“å‰²": [""] // æ™‚é–“å‰²ã‚’å‹•çš„ã«ã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ã®ç©ºã®é…åˆ—
};

const startButton = document.querySelector('#startButton');
const stopButton = document.querySelector('#stopButton');
const resultOutput = document.querySelector('#resultOutput');

if (!'SpeechSynthesisUtterance' in window) {
    alert("ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Speech Synthesis APIã«æœªå¯¾å¿œã§ã™ã€‚");
}
const tts = new SpeechSynthesisUtterance();
tts.lang = "ja-JP";
tts.rate = 2.0;
tts.pitch = 10.0;
tts.volume = 1.0;

SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
if (!'SpeechRecognition' in window) {
    alert("ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Speech Recognition APIã«æœªå¯¾å¿œã§ã™ã€‚");
}

const asr = new SpeechRecognition();
asr.lang = "ja-JP";
asr.interimResults = true;
asr.continuous = true;

let output = '';

// CSVã‚’èª­ã¿è¾¼ã¿ã€æ›œæ—¥ã”ã¨ã®æ™‚é–“å‰²ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
let timetable = {};

function loadCSV() {
    fetch('timetable.csv')
        .then(response => response.text())
        .then(data => {
            let rows = data.split('\n');
            rows.forEach(row => {
                let cols = row.split(',');
                let day = cols[0];
                if (day) {
                    timetable[day] = cols.slice(1);
                }
            });
        });
}

// ç¾åœ¨ã®æ›œæ—¥ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getCurrentDay() {
    const days = ["æ—¥æ›œ", "æœˆæ›œ", "ç«æ›œ", "æ°´æ›œ", "æœ¨æ›œ", "é‡‘æ›œ", "åœŸæ›œ"];
    let now = new Date();
    return days[now.getDay()];
}

// èªè­˜çµæœãŒå‡ºåŠ›ã•ã‚ŒãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
asr.onresult = function(event) {
    let transcript = event.results[event.resultIndex][0].transcript;

    let output_not_final = '';
    if (event.results[event.resultIndex].isFinal) {
        asr.abort();

        let answer;

        let keys = Object.keys(response);
        keys.forEach(function(key) {
            let flag = true;
            console.log(transcript);
            key.split(',').forEach(function(word) {              
                let pattern = new RegExp(word);
                let flag_test = pattern.test(transcript);
                flag = flag && flag_test;
                console.log(pattern + '+' + ':' + flag_test);
            });

            if(flag) {
                answer = response[key];
                if(key === "ä»Š,ä½•æ™‚") {
                    let currentTime = getCurrentTime();
                    answer = ["ç¾åœ¨ã®æ™‚åˆ»ã¯ " + currentTime + " ã§ã™ã€‚"];
                } else if (key === "ä»Šæ—¥,æ™‚é–“å‰²") {
                    let currentDay = getCurrentDay();
                    if (timetable[currentDay]) {
                        answer = ["ä»Šæ—¥ã¯ " + currentDay + " ã§ã™ã€‚æ™‚é–“å‰²ã¯ " + timetable[currentDay].join('ã€') + " ã§ã™ã€‚"];
                    } else {
                        answer = ["ä»Šæ—¥ã¯ " + currentDay + " ã§ã™ã€‚æ™‚é–“å‰²ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"];
                    }
                }

                console.log(key + " : " + answer);

                answer.forEach(function(ans) {
                    if(ans.startsWith("http")) {
                        setTimeout(function() {
                            window.open(ans, '_blank');
                        }, 3000);
                    } else {
                        output += transcript + ' => ' + ans + '<br>';
                        tts.text = ans;
                    }
                });
            }
        });

        if(typeof answer == 'undefined') {
            answer = "ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚ã§ã‚‚ã‚‚ã£ã¨è³¢ããªã‚Šã¾ã™";
            output += transcript + ' => ' + answer + '<br>';
            tts.text = answer;
        }

        tts.onend = function(event) {
            asr.start();
        }

        speechSynthesis.speak(tts);
    } else {
        output_not_final = '<span style="color:#ddd;">' + transcript + '</span>';
    }
    resultOutput.innerHTML = output + output_not_final;
}

startButton.addEventListener('click', function() {
    asr.start();
})

stopButton.addEventListener('click', function() {
    asr.abort();
    asr.stop();
})

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«CSVã‚’èª­ã¿è¾¼ã‚€
window.onload = function() {
    loadCSV();
}

</script>

</body>
</html>
