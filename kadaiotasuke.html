<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日の時間割</title>
</head>
<body>

    <h1>今日の時間割</h1>
    <div id="resultOutput"></div>

    <script>
        // 音声認識と音声合成の初期化
        const asr = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        const tts = new SpeechSynthesisUtterance();

        asr.lang = 'ja-JP';
        asr.interimResults = false;
        asr.continuous = true;

        asr.onstart = function() {
            console.log('音声認識スタート');
        };

        // CSVを読み込んでパースする関数
        function loadCSV(url) {
            return fetch(url)
                .then(response => response.text())
                .then(text => {
                    const lines = text.trim().split('\n');
                    const headers = lines[0].split(',');
                    const data = lines.slice(1).map(line => {
                        const values = line.split(',');
                        return headers.reduce((obj, header, index) => {
                            obj[header] = values[index];
                            return obj;
                        }, {});
                    });
                    return data;
                });
        }

        // 現在の曜日を取得する関数
        function getCurrentDay() {
            const days = ["日曜日", "月曜日", "火曜日", "水曜日", "木曜日", "金曜日", "土曜日"];
            const now = new Date();
            return days[now.getDay()];
        }

        // 今日の時間割を取得して音声で応答する関数
        function getTimetableForToday(timetableData) {
            const today = getCurrentDay();
            const todaySchedule = timetableData.find(day => day["曜日"] === today);

            if (todaySchedule) {
                let timetableText = `今日は ${today} ですから、`;
                for (let i = 1; i <= 5; i++) { // 1限～5限までのループ
                    timetableText += `${i}限：${todaySchedule[`${i}限`]}、`;
                }
                return timetableText.slice(0, -1); // 最後の "、" を削除
            } else {
                return "今日は時間割が見つかりません。";
            }
        }

        // 応答の定義（ハッシュ）    
        var response = {
            "あなた,誰": ["私はあなたのお友達です。たぶん"],
            "名前は": ["私は名もなき新米ボイスアシスタントです。名前はまだない"],
            "何歳": ["私はあなたに呼ばれた度に生まれます。つまり生まれたて"],
            "元気": ["おそらく元気"],
            "好きな,食べ物": ["新鮮な情報体は美味です。人間が食べるオサシミ…？はこのような味がするのでしょうか"],
            "課題,やる": ["頑張ってくださいね", "https://moodle2024.wakayama-u.ac.jp/2024/my/", "https://www.notion.so/"],
            "教えて,先生": ["私はまだ新米なので教えられませんが、代わりに知り合いを数人紹介しましょう", "https://chatgpt.com/", "https://www.deepl.com/ja/translator", "https://gemini.google.com/app?hl=ja"],
            "今日,時間割": [""], // 時間割を動的にセットするための空の配列
            "教育サポート": ["これのことですか？", "https://kmags.wakayama-u.ac.jp/campusweb/campusportal.do?page=main"],
            "今何時": [""] // 時間を動的にセットするための空の配列
        };

        // CSVファイルのURL
        const csvUrl = '/timetable.csv'; // ここにCSVファイルのパスを設定してください

        loadCSV(csvUrl).then(timetableData => {
            asr.onresult = function(event) {
                let transcript = event.results[event.resultIndex][0].transcript; // 結果文字列

                let output_not_final = '';
                if (event.results[event.resultIndex].isFinal) { // 結果が確定（Final）のとき
                    asr.abort(); // 音声認識を停止

                    let answer;

                    let keys = Object.keys(response);
                    keys.forEach(function(key) {
                        let flag = true;
                        console.log(transcript);
                        key.split(',').forEach(function(word) {              
                            let pattern = new RegExp(word);
                            let flag_test = pattern.test(transcript); // マッチしたらtrue, しなかったらfalse
                            flag = flag && flag_test; // 両方trueならtrue
                            console.log(pattern + '+' + ':' + flag_test);
                        });

                        if (flag) {
                            answer = response[key];
                            if (key === "今日,時間割") {
                                // 今日の時間割を取得して応答にセット
                                answer = [getTimetableForToday(timetableData)];
                            } else if (key === "今何時") {
                                // 現在の時刻を取得して応答にセット
                                let currentTime = getCurrentTime();
                                answer = ["現在の時刻は " + currentTime + " です。"];
                            }

                            console.log(key + " : " + answer);

                            // リンクが含まれている場合、3秒後にそのリンクを新しいタブで開く
                            answer.forEach(function(ans) {
                                if (ans.startsWith("http")) {
                                    setTimeout(function() {
                                        window.open(ans, '_blank');
                                    }, 3000); // 3秒後に実行
                                } else {
                                    output += transcript + ' => ' + ans + '<br>';
                                    tts.text = ans;
                                }
                            });
                        }
                    });

                    if (typeof answer == 'undefined') {
                        answer = "わかりません。でももっと賢くなります";
                    }

                    // 再生が終了（end）ときのイベントハンドラ（終了したときに実行される）
                    tts.onend = function(event) {
                        asr.start(); // 音声認識を再開
                    }

                    speechSynthesis.speak(tts); // 再生
                } else { // 結果がまだ未確定のとき
                    output_not_final = '<span style="color:#ddd;">' + transcript + '</span>';
                }
                resultOutput.innerHTML = output + output_not_final;
            }
        });

        // ページが読み込まれたときに音声認識を開始する
        window.onload = function() {
            asr.start();
        };

    </script>

</body>
</html>
