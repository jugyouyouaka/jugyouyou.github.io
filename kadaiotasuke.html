<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spoken Dialog with Timetable</title>
</head>
<body>

<h1>複数のキーワード（順序入れ替え可）</h1>

<p>
<button id="startButton">start</button>
<button id="stopButton">stop</button>
</p>

<p>
<div id="resultOutput"></div>
</p>

<div id="timetable"></div> <!-- 時間割を表示する場所 -->

<script>
// CSVファイルのパス
const csvFilePath = 'timetable.csv';

// 応答の定義（ハッシュ）
var response = {
    "あなた,誰": ["私はあなたのお友達です。たぶん"],
    "名前は": ["私は名もなき新米ボイスアシスタントです。名前はまだない"],
    "何歳": ["私はあなたに呼ばれた度に生まれます。つまり生まれたて"],
    "元気": ["おそらく元気"],
    "好きな,食べ物": ["新鮮な情報体は美味です。人間が食べるオサシミ…？はこのような味がするのでしょうか"],
    "課題,やる": ["頑張ってくださいね", "https://moodle2024.wakayama-u.ac.jp/2024/my/", "https://www.notion.so/"],
    "教えて,先生": ["私はまだ新米なので教えられませんが、代わりに知り合いを数人紹介しましょう", "https://chatgpt.com/", "https://www.deepl.com/ja/translator", "https://gemini.google.com/app?hl=ja"],
    "今日,時間割": [""]
};

// 開始ボタンと停止ボタンの取得
const startButton = document.querySelector('#startButton');
const stopButton = document.querySelector('#stopButton');
const resultOutput = document.querySelector('#resultOutput');
const timetableDiv = document.querySelector('#timetable'); // 時間割表示用

if (!'SpeechSynthesisUtterance' in window) {
    alert("あなたのブラウザはSpeech Synthesis APIに未対応です。");
}
const tts = new SpeechSynthesisUtterance();
tts.lang = "ja-JP";
tts.rate = 2.0;
tts.pitch = 10.0;
tts.volume = 1.0;

SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
if (!'SpeechRecognition' in window) {
    alert("あなたのブラウザはSpeech Recognition APIに未対応です。");
}

const asr = new SpeechRecognition();
asr.lang = "ja-JP";
asr.interimResults = true;
asr.continuous = true;

let output = '';

// CSVファイルを読み込んでパースする関数
function parseCSV(csvData) {
    const lines = csvData.split("\n");
    const result = [];
    const headers = lines[0].split(",");
    
    for (let i = 1; i < lines.length; i++) {
        const obj = {};
        const currentline = lines[i].split(",");
        
        for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = currentline[j];
        }
        
        result.push(obj);
    }
    
    return result;
}

// 曜日から対応する時間割を取得し、表として表示する関数
function displayTimetableForToday(timetable) {
    const now = new Date();
    const daysOfWeek = ["日", "月", "火", "水", "木", "金", "土"];
    const today = daysOfWeek[now.getDay()];
    
    const todayTimetable = timetable.find(row => row["曜日"] === today);
    
    if (todayTimetable) {
        let tableHTML = "<table border='1'><tr><th>時限</th><th>科目</th></tr>";
        Object.keys(todayTimetable).forEach((key, index) => {
            if (key !== "曜日") {
                tableHTML += `<tr><td>${key}</td><td>${todayTimetable[key]}</td></tr>`;
            }
        });
        tableHTML += "</table>";
        timetableDiv.innerHTML = tableHTML;
    } else {
        timetableDiv.innerHTML = "今日は時間割がありません。";
    }
}

// 認識結果が出力されたときのイベントハンドラ
asr.onresult = function(event){
    let transcript = event.results[event.resultIndex][0].transcript;

    if (event.results[event.resultIndex].isFinal) {
        asr.abort();
        
        let answer;
        let keys = Object.keys(response);
        keys.forEach(function(key) {
            let flag = true;
            key.split(',').forEach(function(word) {              
                let pattern = new RegExp(word);
                flag = flag && pattern.test(transcript);
            });

            if(flag){
                answer = response[key];
                if (key === "今日,時間割") {
                    fetch(csvFilePath)
                        .then(response => response.text())
                        .then(csvData => {
                            const timetable = parseCSV(csvData);
                            displayTimetableForToday(timetable);
                        });
                }
            }
        });

        if(typeof answer == 'undefined'){
            answer = "わかりません。でももっと賢くなります";
        }

        tts.text = answer;
        speechSynthesis.speak(tts);
    }
}

// 開始ボタンのイベントハンドラ
startButton.addEventListener('click', function() {
    asr.start();
})

// 停止ボタンのイベントハンドラ
stopButton.addEventListener('click', function() {
    asr.abort();
    asr.stop();
})
</script>

</body>
</html>
